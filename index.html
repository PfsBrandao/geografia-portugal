<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geografia PT — Municípios e Freguesias</title>

  <link rel="icon" href="data:,">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#fff; }
    header {
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid #eee;
      background: #fff;
    }

    /* ---------- telas ---------- */
    .screen { display: none; height: 100vh; }
    .screen.active { display: block; }

    /* ---------- menu / loading ---------- */
    .center {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 18px;
      text-align: center;
    }
    .card {
      width: min(520px, 92vw);
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 16px;
      background: #fafafa;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    button { padding: 10px 12px; cursor: pointer; }
    .small { font-size: 12px; color: #555; }

    /* ---------- jogo ---------- */
    #wrap { height: calc(100vh - 56px); }
    #map { background: #ffffff; }
    #side {
      padding: 12px;
      overflow: auto;
      background: #fafafa;
      border-left: 1px solid #eee;
    }
    input, select, button { padding: 7px; }
    input { min-width: 320px; }

    .kpi { margin: 8px 0 12px; }
    .kpi div { margin: 4px 0; }

    .msg { margin-top: 6px; color: #222; min-height: 18px; }
    .msg.bad { color: #8b0000; }
    .msg.good { color: #0b5; }
    .msg.neutral { color: #555; }

    .btnRow { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }

    .listTitle { margin: 12px 0 6px; font-weight: bold; }
    ul { padding-left: 18px; margin: 6px 0 0; }
    li { margin: 4px 0; }

    /* MOBILE-FIRST */
    #wrap {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 56px);
    }
    #map { flex: 1; min-height: 52vh; }
    #side { border-left: none; border-top: 1px solid #eee; max-height: 40vh; }

    header { flex-direction: column; align-items: stretch; }
    header label, header input, header button, header select { width: 100%; }

    @media (min-width: 900px) {
      #wrap {
        display: grid;
        grid-template-columns: 1fr 320px;
        height: calc(100vh - 56px);
      }
      #side { border-left: 1px solid #eee; border-top: none; max-height: none; }
      header { flex-direction: row; align-items: center; }
      header label, header input, header button, header select { width: auto; }
    }

    /* loading bar */
    .bar {
      width: min(420px, 90vw);
      height: 10px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #e6e6e6;
    }
    .bar > div {
      height: 100%;
      width: 0%;
      background: #111;
      transition: width 220ms ease;
    }
  </style>
</head>
<body>

  <!-- SCREEN: MENU -->
  <div id="screenMenu" class="screen active">
    <div class="center">
      <div class="card">
        <h2 style="margin:6px 0 10px;">Geografia PT</h2>
        <div class="small" style="margin-bottom:12px;">
          Escolhe o tipo de jogo. Vamos carregar apenas os ficheiros necessários.
        </div>
        <div class="row">
          <button id="startMunicipios">Municípios (por Distrito)</button>
          <button id="startFreguesias">Freguesias (por Município)</button>
        </div>
        <div class="small" style="margin-top:12px;">
          Dica: no modo Municípios carrega mais rápido.
        </div>
      </div>
    </div>
  </div>

  <!-- SCREEN: LOADING -->
  <div id="screenLoading" class="screen">
    <div class="center">
      <div class="card">
        <h3 style="margin:6px 0 10px;">A carregar…</h3>
        <div id="loadingText" class="small" style="margin-bottom:10px;">—</div>
        <div class="bar"><div id="loadingBar"></div></div>
        <div id="loadingPct" class="small" style="margin-top:10px;">0%</div>
      </div>
    </div>
  </div>

  <!-- SCREEN: GAME -->
  <div id="screenGame" class="screen">
    <header>
      <button id="backToMenu">Voltar ao menu</button>

      <label>Visual:
        <select id="viewMode">
          <option value="jogo">Jogo (sem nomes)</option>
          <option value="treino">Treino (com nomes)</option>
        </select>
      </label>

      <label id="label-area">—:
        <select id="area"></select>
      </label>

      <input
        id="guess"
        type="text"
        placeholder="Escreve um nome…"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="words"
        enterkeyhint="done"
      />
      <button id="reset">Repor</button>
    </header>

    <div id="wrap">
      <div id="map"></div>
      <div id="side">
        <div class="kpi">
          <div><strong id="titleLine">—</strong></div>
          <div>Acertados: <strong id="scoreLine">0</strong></div>
          <div class="small" id="hintLine">—</div>
        </div>

        <div class="btnRow">
          <button id="btnShowMissing" style="display:none;">Mostrar faltas</button>
          <button id="btnHideMissing" style="display:none;">Esconder faltas</button>
          <button id="btnRevealAll" style="display:none;">Revelar tudo</button>
        </div>

        <div class="msg neutral" id="msg"></div>

        <div id="missingBlock" style="display:none;">
          <div class="listTitle">Faltam</div>
          <ul id="missingList"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DATA = {
      concelhos: "https://raw.githubusercontent.com/nmota/caop_GeoJSON/master/ContinenteConcelhos.geojson",
      distritos: "https://raw.githubusercontent.com/nmota/caop_GeoJSON/master/ContinenteDistritos.geojson",
      freguesias: "https://raw.githubusercontent.com/nmota/caop_GeoJSON/master/ContinenteFreguesias.geojson"
    };

    // EPSG:3763 (PT-TM06/ETRS89)
    const EPSG3763_DEF =
      "+proj=tmerc +lat_0=39.66825833333333 +lon_0=-8.133108333333333 " +
      "+k=1 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs";
    proj4.defs("EPSG:3763", EPSG3763_DEF);

    // Screens
    const screenMenu = document.getElementById("screenMenu");
    const screenLoading = document.getElementById("screenLoading");
    const screenGame = document.getElementById("screenGame");
    function showScreen(s) {
      for (const el of [screenMenu, screenLoading, screenGame]) el.classList.remove("active");
      s.classList.add("active");
    }

    // Loading UI
    const loadingText = document.getElementById("loadingText");
    const loadingBar = document.getElementById("loadingBar");
    const loadingPct = document.getElementById("loadingPct");
    function setLoading(step, pct) {
      loadingText.textContent = step;
      loadingBar.style.width = `${pct}%`;
      loadingPct.textContent = `${pct}%`;
    }

    // Game UI elements
    const viewModeSel = document.getElementById("viewMode");
    const areaSel = document.getElementById("area");
    const areaLabel = document.getElementById("label-area");
    const guessInput = document.getElementById("guess");
    const titleLine = document.getElementById("titleLine");
    const scoreLine = document.getElementById("scoreLine");
    const hintLine = document.getElementById("hintLine");
    const msgEl = document.getElementById("msg");
    const btnShowMissing = document.getElementById("btnShowMissing");
    const btnHideMissing = document.getElementById("btnHideMissing");
    const btnRevealAll = document.getElementById("btnRevealAll");
    const missingBlock = document.getElementById("missingBlock");
    const missingList = document.getElementById("missingList");

    // Map (created once)
    const map = L.map("map", { zoomControl: true, attributionControl: false });
    map.setView([39.5, -8.0], 7);

    // Data (lazy loaded)
    let allConcelhos = null;
    let allDistritos = null;
    let allFreguesias = null;

    // Current mode: "municipios" or "freguesias"
    let gameType = null;

    // Layers
    let fillLayer = null;
    let outlineLayer = null;

    // Gameplay state
    let byKey = new Map();
    let keyToOfficial = new Map();
    let solved = new Set();
    let total = 0;
    let aliases = new Map();

    function normalize(s) {
      return (s || "")
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function setMsg(text, type="neutral") {
      msgEl.className = "msg " + type;
      msgEl.textContent = text || "";
    }

    function getDistrictName(p) { return (p && p.Distrito) ? String(p.Distrito) : ""; }
    function getMunicipalityName(p) { return (p && p.Concelho) ? String(p.Concelho) : ""; }
    function getParishName(p) { return (p && p.Freguesia) ? String(p.Freguesia) : ""; }

    async function loadGeoJSON(url) {
      const txt = await fetch(url).then(r => {
        if (!r.ok) throw new Error(`Falha a carregar (HTTP ${r.status})`);
        return r.text();
      });
      const clean = (txt.charCodeAt(0) === 0xFEFF) ? txt.slice(1) : txt;
      return JSON.parse(clean);
    }

    function looksProjected(feature) {
      const g = feature && feature.geometry;
      if (!g) return false;

      function firstXY(coords) {
        if (!Array.isArray(coords)) return null;
        if (coords.length && typeof coords[0] === "number") return coords;
        for (const c of coords) {
          const v = firstXY(c);
          if (v) return v;
        }
        return null;
      }

      const xy = firstXY(g.coordinates);
      if (!xy) return false;
      const x = xy[0], y = xy[1];
      return Math.abs(x) > 180 || Math.abs(y) > 90;
    }

    function reprojectCoord(xy) {
      return proj4("EPSG:3763", "WGS84", xy); // [lon, lat]
    }

    function reprojectGeometry(geom) {
      const t = geom.type;
      const c = geom.coordinates;

      if (t === "Point") return { type: "Point", coordinates: reprojectCoord(c) };
      if (t === "MultiPoint" || t === "LineString") return { type: t, coordinates: c.map(reprojectCoord) };
      if (t === "MultiLineString" || t === "Polygon") return { type: t, coordinates: c.map(r => r.map(reprojectCoord)) };
      if (t === "MultiPolygon") return { type: "MultiPolygon", coordinates: c.map(p => p.map(r => r.map(reprojectCoord))) };
      return geom;
    }

    function reprojectFC(fc) {
      if (!fc.features || fc.features.length === 0) return fc;
      const needs = looksProjected(fc.features[0]);
      if (!needs) return fc;

      return {
        type: "FeatureCollection",
        features: fc.features.map(f => ({
          type: "Feature",
          properties: f.properties || {},
          geometry: reprojectGeometry(f.geometry)
        }))
      };
    }

    function buildAliasesForCurrentSet() {
      const a = new Map();
      for (const [k] of keyToOfficial.entries()) a.set(k, k);

      const add = (alias, officialName) => {
        const aa = normalize(alias);
        const oo = normalize(officialName);
        if (keyToOfficial.has(oo)) a.set(aa, oo);
      };

      // atalhos úteis (municipios)
      add("gaia", "Vila Nova de Gaia");
      add("feira", "Santa Maria da Feira");
      add("figueira", "Figueira da Foz");
      add("povoa", "Póvoa de Varzim");
      add("povoa de varzim", "Póvoa de Varzim");
      add("s joao da madeira", "São João da Madeira");
      add("sao joao da madeira", "São João da Madeira");
      add("viana", "Viana do Castelo");
      add("loule", "Loulé");
      add("olhao", "Olhão");

      return a;
    }

    function styleFill(feature) {
      const p = feature.properties || {};
      const raw = (gameType === "municipios") ? getMunicipalityName(p) : getParishName(p);
      const key = normalize(raw);
      const ok = solved.has(key);

      return {
        color: "#000",
        weight: 1.1,
        fillColor: ok ? "#111" : "#fff",
        fillOpacity: 1
      };
    }

    function clearLayers() {
      if (fillLayer) fillLayer.remove();
      if (outlineLayer) outlineLayer.remove();
      fillLayer = null;
      outlineLayer = null;
      byKey.clear();
      keyToOfficial.clear();
      solved.clear();
      total = 0;
      scoreLine.textContent = "0";
      setMsg("");
    }

    function buildFillLayer(fcWgs84) {
      if (fillLayer) fillLayer.remove();
      byKey.clear();
      keyToOfficial.clear();
      solved.clear();

      fillLayer = L.geoJSON(fcWgs84, {
        style: styleFill,
        onEachFeature: (feature, lyr) => {
          const p = feature.properties || {};
          const raw = (gameType === "municipios") ? getMunicipalityName(p) : getParishName(p);
          const key = normalize(raw);

          if (key) {
            byKey.set(key, lyr);
            keyToOfficial.set(key, raw);
          }

          if (viewModeSel.value === "treino" && raw) {
            lyr.bindTooltip(raw, { sticky: true, opacity: 0.85 });
          }
        }
      }).addTo(map);

      total = byKey.size;
      aliases = buildAliasesForCurrentSet();

      if (total > 0) map.fitBounds(fillLayer.getBounds(), { padding: [12, 12] });
      updateUI();
    }

    function drawDistrictOutline(districtName) {
      if (outlineLayer) outlineLayer.remove();
      outlineLayer = null;
      if (!allDistritos) return;

      const wanted = normalize(districtName);
      const feats = allDistritos.features.filter(
        f => normalize(getDistrictName(f.properties || {})) === wanted
      );
      if (feats.length === 0) return;

      const fc = reprojectFC({ type: "FeatureCollection", features: feats });

      outlineLayer = L.geoJSON(fc, {
        style: { color: "#7A0000", weight: 4, fillOpacity: 0, opacity: 1 }
      }).addTo(map);
    }

    function refreshStyles() {
      if (!fillLayer) return;
      fillLayer.setStyle(styleFill);
    }

    function flashLayer(lyr) {
      if (!lyr) return;
      try {
        const flash = { color: "#00AA55", weight: 3.5 };
        lyr.setStyle(flash);
        setTimeout(() => lyr.setStyle(styleFill(lyr.feature)), 220);
      } catch (_) {}
    }

    function updateUI() {
      scoreLine.textContent = `${solved.size} / ${total}`;
      titleLine.textContent = (gameType === "municipios")
        ? `Distrito: ${areaSel.value || "—"}`
        : `Município: ${areaSel.value || "—"}`;

      if (viewModeSel.value === "jogo") {
        hintLine.textContent = "Modo Jogo: sem nomes, apenas progresso.";
        btnShowMissing.style.display = "none";
        btnHideMissing.style.display = "none";
        btnRevealAll.style.display = "none";
        missingBlock.style.display = "none";
      } else {
        hintLine.textContent = "Modo Treino: podes ver o que falta e revelar tudo.";
        btnShowMissing.style.display = missingBlock.style.display === "none" ? "inline-block" : "none";
        btnHideMissing.style.display = missingBlock.style.display === "none" ? "none" : "inline-block";
        btnRevealAll.style.display = "inline-block";
      }

      if (missingBlock.style.display !== "none") renderMissingList();
    }

    function renderMissingList() {
      const missing = [];
      for (const [key, official] of keyToOfficial.entries()) {
        if (!solved.has(key)) missing.push(official);
      }
      missing.sort((a,b)=>a.localeCompare(b,"pt"));

      missingList.innerHTML = "";
      for (const name of missing) {
        const li = document.createElement("li");
        li.textContent = name;
        missingList.appendChild(li);
      }
    }

    function fillAreaSelectorForDistricts() {
      const set = new Set();
      for (const f of allConcelhos.features) {
        const d = getDistrictName(f.properties || {});
        if (d) set.add(d);
      }
      const arr = Array.from(set).sort((a,b)=>a.localeCompare(b, "pt"));
      areaSel.innerHTML = "";
      for (const d of arr) areaSel.appendChild(new Option(d, d));
    }

    function fillAreaSelectorForMunicipalities() {
      const set = new Set();
      for (const f of allFreguesias.features) {
        const m = getMunicipalityName(f.properties || {});
        if (m) set.add(m);
      }
      const arr = Array.from(set).sort((a,b)=>a.localeCompare(b, "pt"));
      areaSel.innerHTML = "";
      for (const m of arr) areaSel.appendChild(new Option(m, m));
    }

    function loadMunicipiosForDistrict(districtName) {
      solved.clear();
      setMsg("");
      missingBlock.style.display = "none";

      const wanted = normalize(districtName);
      const feats = allConcelhos.features.filter(
        f => normalize(getDistrictName(f.properties || {})) === wanted
      );

      const fc = reprojectFC({ type: "FeatureCollection", features: feats });
      buildFillLayer(fc);
      drawDistrictOutline(districtName);
      updateUI();
    }

    function loadFreguesiasForMunicipio(municipalityName) {
      solved.clear();
      setMsg("");
      missingBlock.style.display = "none";

      if (outlineLayer) outlineLayer.remove();
      outlineLayer = null;

      const wanted = normalize(municipalityName);
      const feats = allFreguesias.features.filter(
        f => normalize(getMunicipalityName(f.properties || {})) === wanted
      );

      const fc = reprojectFC({ type: "FeatureCollection", features: feats });
      buildFillLayer(fc);
      updateUI();
    }

    function resolveTypedToKey(typedNorm) {
      if (aliases.has(typedNorm)) return aliases.get(typedNorm);
      if (byKey.has(typedNorm)) return typedNorm;

      const simplified = typedNorm
        .replace(/^vila nova de /, "")
        .replace(/^santa maria da /, "")
        .replace(/^sao /, "")
        .replace(/^são /, "")
        .trim();

      if (aliases.has(simplified)) return aliases.get(simplified);
      if (byKey.has(simplified)) return simplified;

      return "";
    }

    function handleGuess(rawInput) {
      const typed = normalize(rawInput);
      if (!typed) return;

      const key = resolveTypedToKey(typed);
      if (!key) {
        setMsg(`Não encontrado: "${rawInput}"`, "bad");
        guessInput.focus();
        return;
      }

      if (solved.has(key)) {
        setMsg(`Já estava: ${keyToOfficial.get(key) || rawInput}`, "neutral");
        guessInput.focus();
        return;
      }

      solved.add(key);
      refreshStyles();

      flashLayer(byKey.get(key));

      setMsg(`Certo: ${keyToOfficial.get(key) || rawInput}`, "good");
      updateUI();

      if (solved.size === total && total > 0) setMsg("Concluído. Acertaste tudo.", "good");

      guessInput.focus();
    }

    // Buttons
    document.getElementById("reset").addEventListener("click", () => {
      solved.clear();
      refreshStyles();
      missingBlock.style.display = "none";
      setMsg("");
      updateUI();
      guessInput.focus();
    });

    btnShowMissing.addEventListener("click", () => {
      missingBlock.style.display = "block";
      updateUI();
    });

    btnHideMissing.addEventListener("click", () => {
      missingBlock.style.display = "none";
      updateUI();
    });

    btnRevealAll.addEventListener("click", () => {
      if (viewModeSel.value !== "treino") return;
      for (const key of byKey.keys()) solved.add(key);
      refreshStyles();
      setMsg("Revelado (modo treino).", "neutral");
      updateUI();
      guessInput.focus();
    });

    // Guess input
    guessInput.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const raw = guessInput.value;
      guessInput.value = "";
      handleGuess(raw);
    });

    // View mode change: reload layer to show/hide tooltips
    viewModeSel.addEventListener("change", () => {
      missingBlock.style.display = "none";
      setMsg("");
      if (gameType === "municipios") loadMunicipiosForDistrict(areaSel.value);
      else loadFreguesiasForMunicipio(areaSel.value);
      guessInput.focus();
    });

    // Area change
    areaSel.addEventListener("change", () => {
      missingBlock.style.display = "none";
      setMsg("");
      if (gameType === "municipios") loadMunicipiosForDistrict(areaSel.value);
      else loadFreguesiasForMunicipio(areaSel.value);
      guessInput.focus();
    });

    // Back to menu
    document.getElementById("backToMenu").addEventListener("click", () => {
      clearLayers();
      showScreen(screenMenu);
    });

    // Start buttons
    document.getElementById("startMunicipios").addEventListener("click", async () => {
      gameType = "municipios";
      showScreen(screenLoading);
      setLoading("A iniciar…", 5);

      try {
        // carregar só o necessário
        setLoading("A carregar concelhos…", 25);
        allConcelhos = allConcelhos || await loadGeoJSON(DATA.concelhos);

        setLoading("A carregar distritos…", 55);
        allDistritos = allDistritos || await loadGeoJSON(DATA.distritos);

        setLoading("A preparar lista de distritos…", 75);
        fillAreaSelectorForDistricts();

        // preparar UI labels
        areaLabel.childNodes[0].nodeValue = "Distrito: ";
        viewModeSel.value = "jogo";
        missingBlock.style.display = "none";
        setMsg("");

        setLoading("A desenhar mapa…", 90);
        showScreen(screenGame);

        loadMunicipiosForDistrict(areaSel.value);

        setLoading("Concluído", 100);
        guessInput.focus();
      } catch (e) {
        console.error(e);
        setLoading("Erro a carregar dados. Ver Console.", 100);
      }
    });

    document.getElementById("startFreguesias").addEventListener("click", async () => {
      gameType = "freguesias";
      showScreen(screenLoading);
      setLoading("A iniciar…", 5);

      try {
        // freguesias precisa de freguesias; lista de municípios vem do próprio ficheiro
        setLoading("A carregar freguesias…", 35);
        allFreguesias = allFreguesias || await loadGeoJSON(DATA.freguesias);

        setLoading("A preparar lista de municípios…", 70);
        fillAreaSelectorForMunicipalities();

        areaLabel.childNodes[0].nodeValue = "Município: ";
        viewModeSel.value = "jogo";
        missingBlock.style.display = "none";
        setMsg("");

        setLoading("A desenhar mapa…", 90);
        showScreen(screenGame);

        loadFreguesiasForMunicipio(areaSel.value);

        setLoading("Concluído", 100);
        guessInput.focus();
      } catch (e) {
        console.error(e);
        setLoading("Erro a carregar dados. Ver Console.", 100);
      }
    });
  </script>
</body>
</html>





