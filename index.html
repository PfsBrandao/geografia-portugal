<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geografia PT — Distritos, Municípios, Freguesias</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Só precisamos de Proj4 (vamos reprojetar nós, sem Proj4Leaflet) -->
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    #map { height: calc(100vh - 74px); background: #ffffff; }
    input, select, button { padding: 8px; }
    input { min-width: 320px; }
    .status { color: #222; }
  </style>
</head>
<body>
  <header>
    <label>Modo:
      <select id="mode">
        <option value="municipios">Municípios (por Distrito)</option>
        <option value="freguesias">Freguesias (por Município)</option>
      </select>
    </label>

    <label id="label-area">Distrito:
      <select id="area"></select>
    </label>

    <label>Visual:
      <select id="viewMode">
        <option value="jogo">Jogo (sem nomes)</option>
        <option value="treino">Treino (mostra nomes)</option>
      </select>
    </label>

    <input id="guess" type="text" placeholder="Escreve um nome e carrega Enter" />
    <button id="reset">Repor</button>
    <div class="status" id="status"></div>
  </header>

  <div id="map"></div>

  <script>
    // Dados CAOP (remoto)
    const DATA = {
      concelhos: "https://raw.githubusercontent.com/nmota/caop_GeoJSON/master/ContinenteConcelhos.geojson",
      distritos: "https://raw.githubusercontent.com/nmota/caop_GeoJSON/master/ContinenteDistritos.geojson",
      freguesias: "https://raw.githubusercontent.com/nmota/caop_GeoJSON/master/ContinenteFreguesias.geojson"
    };

    // Definir EPSG:3763 (PT-TM06/ETRS89)
    const EPSG3763_DEF =
      "+proj=tmerc +lat_0=39.66825833333333 +lon_0=-8.133108333333333 " +
      "+k=1 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs";
    proj4.defs("EPSG:3763", EPSG3763_DEF);

    function normalize(s) {
      return (s || "")
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function pickProp(props, keys) {
      for (const k of keys) {
        if (props && props[k] != null && String(props[k]).trim() !== "") return String(props[k]);
      }
      return "";
    }

    // Nos ficheiros que tu tens, estes campos existem:
    function getDistrictName(props)     { return pickProp(props, ["Distrito", "NM_DIST", "DTMN", "DTMN11", "NAME"]); }
    function getMunicipalityName(props) { return pickProp(props, ["Concelho", "NM_CONCEL", "CONCELHO", "NAME"]); }
    function getParishName(props)       { return pickProp(props, ["Freguesia", "NM_FREG", "FREGUESIA", "NAME"]); }

    // Leaflet normal, sem tile layer, sem atribuição
    const map = L.map("map", { zoomControl: true, attributionControl: false });

    let allConcelhos = null;
    let allDistritos = null;
    let allFreguesias = null;

    let fillLayer = null;
    let outlineLayer = null;

    let byName = new Map();
    let solved = new Set();
    let total = 0;

    const modeSel = document.getElementById("mode");
    const areaSel = document.getElementById("area");
    const areaLabel = document.getElementById("label-area");
    const viewModeSel = document.getElementById("viewMode");
    const guessInput = document.getElementById("guess");
    const statusEl = document.getElementById("status");

    function updateStatus(msg) {
      if (msg) { statusEl.textContent = msg; return; }
      statusEl.textContent = `Acertados: ${solved.size} / ${total}`;
    }

    function styleFill(feature) {
      const props = feature.properties || {};
      const rawName = (modeSel.value === "municipios") ? getMunicipalityName(props) : getParishName(props);
      const key = normalize(rawName);
      const ok = solved.has(key);

      return {
        color: "#000",
        weight: 1.2,
        fillColor: ok ? "#111" : "#fff",
        fillOpacity: 1
      };
    }

    // ---------- REPROJEÇÃO 3763 -> WGS84 (lat/lon) ----------
    function reprojectCoordXY(xy) {
      // proj4 devolve [lon, lat]
      const out = proj4("EPSG:3763", "WGS84", xy);
      return out;
    }

    function reprojectGeometry(geom) {
      const t = geom.type;
      const c = geom.coordinates;

      if (t === "Point") {
        return { type: "Point", coordinates: reprojectCoordXY(c) };
      }
      if (t === "MultiPoint" || t === "LineString") {
        return { type: t, coordinates: c.map(reprojectCoordXY) };
      }
      if (t === "MultiLineString" || t === "Polygon") {
        return { type: t, coordinates: c.map(ring => ring.map(reprojectCoordXY)) };
      }
      if (t === "MultiPolygon") {
        return { type: "MultiPolygon", coordinates: c.map(poly => poly.map(ring => ring.map(reprojectCoordXY))) };
      }
      return geom;
    }

    function reprojectFeature(f) {
      return {
        type: "Feature",
        properties: f.properties || {},
        geometry: reprojectGeometry(f.geometry)
      };
    }

    function reprojectFeatureCollection(features) {
      return { type: "FeatureCollection", features: features.map(reprojectFeature) };
    }
    // --------------------------------------------------------

    function clearLayers() {
      if (fillLayer) fillLayer.remove();
      if (outlineLayer) outlineLayer.remove();
      fillLayer = null;
      outlineLayer = null;
      byName.clear();
      solved.clear();
      total = 0;
      updateStatus();
    }

    function buildFillLayer(fcWgs84) {
      if (fillLayer) fillLayer.remove();
      byName.clear();
      solved.clear();

      fillLayer = L.geoJSON(fcWgs84, {
        style: styleFill,
        onEachFeature: (feature, lyr) => {
          const props = feature.properties || {};
          const rawName = (modeSel.value === "municipios") ? getMunicipalityName(props) : getParishName(props);
          const key = normalize(rawName);
          if (key) byName.set(key, lyr);

          if (viewModeSel.value === "treino" && rawName) {
            lyr.bindTooltip(rawName, { sticky: true, opacity: 0.85 });
          }
        }
      }).addTo(map);

      total = byName.size;
      if (total > 0) map.fitBounds(fillLayer.getBounds(), { padding: [10, 10] });
      updateStatus();
    }

    function drawDistrictOutline(districtName) {
      if (outlineLayer) outlineLayer.remove();
      outlineLayer = null;

      const wanted = normalize(districtName);
      const feats = allDistritos.features.filter(
        f => normalize(getDistrictName(f.properties || {})) === wanted
      );
      if (feats.length === 0) return;

      const fcWgs84 = reprojectFeatureCollection(feats);

      outlineLayer = L.geoJSON(fcWgs84, {
        style: { color: "#7A0000", weight: 4, fillOpacity: 0, opacity: 1 }
      }).addTo(map);
    }

    function fillAreaSelectorForDistricts() {
      const set = new Set();
      for (const f of allConcelhos.features) {
        const d = getDistrictName(f.properties || {});
        if (d) set.add(d);
      }
      const districts = Array.from(set).sort((a,b)=>a.localeCompare(b, "pt"));
      areaSel.innerHTML = "";
      for (const d of districts) areaSel.appendChild(new Option(d, d));
    }

    function fillAreaSelectorForMunicipalities() {
      const set = new Set();
      for (const f of allFreguesias.features) {
        const m = getMunicipalityName(f.properties || {});
        if (m) set.add(m);
      }
      const munis = Array.from(set).sort((a,b)=>a.localeCompare(b, "pt"));
      areaSel.innerHTML = "";
      for (const m of munis) areaSel.appendChild(new Option(m, m));
    }

    function loadMunicipiosForDistrict(districtName) {
      solved.clear();

      const wanted = normalize(districtName);
      const feats = allConcelhos.features.filter(
        f => normalize(getDistrictName(f.properties || {})) === wanted
      );

      const fcWgs84 = reprojectFeatureCollection(feats);
      buildFillLayer(fcWgs84);
      drawDistrictOutline(districtName);
    }

    function loadFreguesiasForMunicipio(municipalityName) {
      solved.clear();

      if (outlineLayer) outlineLayer.remove();
      outlineLayer = null;

      const wanted = normalize(municipalityName);
      const feats = allFreguesias.features.filter(
        f => normalize(getMunicipalityName(f.properties || {})) === wanted
      );

      const fcWgs84 = reprojectFeatureCollection(feats);
      buildFillLayer(fcWgs84);
    }

    function refreshStyles() {
      if (!fillLayer) return;
      fillLayer.setStyle(styleFill);
      updateStatus();
    }

    async function init() {
      allConcelhos = await fetch(DATA.concelhos).then(r => r.json());
      allDistritos = await fetch(DATA.distritos).then(r => r.json());
      allFreguesias = await fetch(DATA.freguesias).then(r => r.json());

      modeSel.value = "municipios";
      areaLabel.childNodes[0].nodeValue = "Distrito: ";
      fillAreaSelectorForDistricts();
      loadMunicipiosForDistrict(areaSel.value);
      guessInput.focus();
    }

    modeSel.addEventListener("change", () => {
      solved.clear();
      refreshStyles();

      if (modeSel.value === "municipios") {
        areaLabel.childNodes[0].nodeValue = "Distrito: ";
        fillAreaSelectorForDistricts();
        loadMunicipiosForDistrict(areaSel.value);
      } else {
        areaLabel.childNodes[0].nodeValue = "Município: ";
        fillAreaSelectorForMunicipalities();
        loadFreguesiasForMunicipio(areaSel.value);
      }

      guessInput.value = "";
      guessInput.focus();
    });

    areaSel.addEventListener("change", () => {
      solved.clear();
      refreshStyles();

      if (modeSel.value === "municipios") loadMunicipiosForDistrict(areaSel.value);
      else loadFreguesiasForMunicipio(areaSel.value);

      guessInput.value = "";
      guessInput.focus();
    });

    viewModeSel.addEventListener("change", () => {
      if (modeSel.value === "municipios") loadMunicipiosForDistrict(areaSel.value);
      else loadFreguesiasForMunicipio(areaSel.value);
      guessInput.focus();
    });

    guessInput.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const typed = normalize(guessInput.value);
      guessInput.value = "";
      if (!typed) return;

      if (byName.has(typed)) {
        solved.add(typed);
        refreshStyles();
      } else {
        updateStatus(`Não encontrado: "${typed}"`);
        setTimeout(() => updateStatus(), 1200);
      }
    });

    document.getElementById("reset").addEventListener("click", () => {
      solved.clear();
      refreshStyles();
      guessInput.focus();
    });

    init();
  </script>
</body>
</html>




