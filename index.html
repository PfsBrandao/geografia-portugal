<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geografia PT — Municípios e Freguesias</title>
  <link rel="icon" href="data:,">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#fff; }
    header {
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid #eee;
      background: #fff;
    }

    .screen { display: none; height: 100vh; }
    .screen.active { display: block; }

    .center {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 18px;
      text-align: center;
    }
    .card {
      width: min(560px, 94vw);
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 16px;
      background: #fafafa;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    button { padding: 10px 12px; cursor: pointer; }
    .small { font-size: 12px; color: #555; }
    .bar {
      width: min(420px, 90vw);
      height: 10px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #e6e6e6;
    }
    .bar > div {
      height: 100%;
      width: 0%;
      background: #111;
      transition: width 220ms ease;
    }

    #wrap { height: calc(100vh - 56px); }
    #map { background: #fff; }
    #side {
      padding: 12px;
      overflow: auto;
      background: #fafafa;
      border-left: 1px solid #eee;
    }
    input, select, button { padding: 7px; }
    input { min-width: 320px; }

    .kpi { margin: 8px 0 12px; }
    .kpi div { margin: 4px 0; }

    .msg { margin-top: 6px; color: #222; min-height: 18px; }
    .msg.bad { color: #8b0000; }
    .msg.good { color: #0b5; }
    .msg.neutral { color: #555; }

    .btnRow { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }

    .listTitle { margin: 12px 0 6px; font-weight: bold; }
    ul { padding-left: 18px; margin: 6px 0 0; }
    li { margin: 4px 0; }

    /* MOBILE-FIRST */
    #wrap { display: flex; flex-direction: column; height: calc(100vh - 56px); }
    #map { flex: 1; min-height: 52vh; }
    #side { border-left: none; border-top: 1px solid #eee; max-height: 40vh; }

    header { flex-direction: column; align-items: stretch; }
    header label, header input, header button, header select { width: 100%; }

    @media (min-width: 900px) {
      #wrap { display: grid; grid-template-columns: 1fr 340px; height: calc(100vh - 56px); }
      #side { border-left: 1px solid #eee; border-top: none; max-height: none; }
      header { flex-direction: row; align-items: center; }
      header label, header input, header button, header select { width: auto; }
    }
  </style>
</head>

<body>
  <!-- SCREEN: MENU -->
  <div id="screenMenu" class="screen active">
    <div class="center">
      <div class="card">
        <h2 style="margin:6px 0 10px;">Geografia PT</h2>
        <div class="small" style="margin-bottom:12px;">
          Escolhe a região. A app vai descarregar apenas o que for necessário.
        </div>
        <div class="row">
          <button id="startPT">Portugal Continental</button>
          <button id="startAZ">Zonas Autónomas — Açores</button>
          <button id="startMD">Zonas Autónomas — Madeira</button>
        </div>
        <div class="small" style="margin-top:12px;">
          Nota: no Continente escolhes Distrito; nas Zonas Autónomas não usamos “Ilha”.
        </div>
      </div>
    </div>
  </div>

  <!-- SCREEN: LOADING -->
  <div id="screenLoading" class="screen">
    <div class="center">
      <div class="card">
        <h3 style="margin:6px 0 10px;">A carregar…</h3>
        <div id="loadingText" class="small" style="margin-bottom:10px;">—</div>
        <div class="bar"><div id="loadingBar"></div></div>
        <div id="loadingPct" class="small" style="margin-top:10px;">0%</div>
      </div>
    </div>
  </div>

  <!-- SCREEN: GAME -->
  <div id="screenGame" class="screen">
    <header>
      <button id="backToMenu">Voltar ao menu</button>

      <label>Modo:
        <select id="gameMode">
          <option value="municipios">Municípios</option>
          <option value="freguesias">Freguesias</option>
        </select>
      </label>

      <label>Visual:
        <select id="viewMode">
          <option value="jogo">Jogo (sem nomes)</option>
          <option value="treino">Treino (com nomes)</option>
        </select>
      </label>

      <label id="labelDistrict" style="display:none;">Distrito:
        <select id="district"></select>
      </label>

      <label id="labelMunicipality" style="display:none;">Município:
        <select id="municipality"></select>
      </label>

      <input
        id="guess"
        type="text"
        placeholder="Escreve um nome…"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="words"
        enterkeyhint="done"
      />
      <button id="reset">Repor</button>
    </header>

    <div id="wrap">
      <div id="map"></div>
      <div id="side">
        <div class="kpi">
          <div><strong id="titleLine">—</strong></div>
          <div>Acertados: <strong id="scoreLine">0</strong></div>
          <div class="small" id="hintLine">—</div>
        </div>

        <div class="btnRow">
          <button id="btnShowMissing" style="display:none;">Mostrar faltas</button>
          <button id="btnHideMissing" style="display:none;">Esconder faltas</button>
          <button id="btnRevealAll" style="display:none;">Revelar tudo</button>
        </div>

        <div class="msg neutral" id="msg"></div>

        <div id="missingBlock" style="display:none;">
          <div class="listTitle">Faltam</div>
          <ul id="missingList"></ul>
        </div>

        <div class="small" style="margin-top:12px;">
          Dados em <code>/data</code> (nomes reais no repo):<br>
          <span id="dataHint"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Configurações de ficheiros (BATEM com o teu /data no GitHub)
    // -----------------------------
    const FILES = {
      // Continente: 1 ficheiro por distrito (ex.: data/concelhos_aveiro.geojson)
      concelhosPT: (districtSlug) => `data/concelhos_${districtSlug}.geojson`,

      // Zonas Autónomas: 1 ficheiro por região
      concelhosAZ: `data/concelhos_acores.geojson`,
      concelhosMD: `data/concelhos_madeira.geojson`,

      // Freguesias: 1 ficheiro por município (ex.: data/freguesias_abrantes.geojson)
      freguesias: (_region, municipalitySlug) => `data/freguesias_${municipalitySlug}.geojson`,
    };

    // Lista de distritos
    const DISTRICTS_PT = [
      ["Aveiro","aveiro"], ["Beja","beja"], ["Braga","braga"], ["Bragança","braganca"],
      ["Castelo Branco","castelo_branco"], ["Coimbra","coimbra"], ["Évora","evora"],
      ["Faro","faro"], ["Guarda","guarda"], ["Leiria","leiria"], ["Lisboa","lisboa"],
      ["Portalegre","portalegre"], ["Porto","porto"], ["Santarém","santarem"],
      ["Setúbal","setubal"], ["Viana do Castelo","viana_do_castelo"],
      ["Vila Real","vila_real"], ["Viseu","viseu"]
    ];

    // -----------------------------
    // Utilitários
    // -----------------------------
    function normalize(s) {
      return (s || "")
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }
    function slugify(name) {
      let s = normalize(name);
      s = s.replace(/[ \t\-\/]+/g, "_");
      s = s.replace(/[^a-z0-9_]/g, "");
      s = s.replace(/_+/g, "_").replace(/^_+|_+$/g, "");
      return s;
    }
    function pickProp(props, keys) {
      for (const k of keys) {
        if (props && props[k] != null && String(props[k]).trim() !== "") return String(props[k]);
      }
      return "";
    }

    function getMunicipalityName(props) {
      return pickProp(props, ["Concelho","CONCELHO","MUNICIPIO","Municipio","MUNICÍPIO","municipio","NAME_2","NAME2","NAME"]);
    }
    function getParishName(props) {
      return pickProp(props, ["Freguesia","FREGUESIA","NM_FREG","parish","NAME_3","NAME3","NAME"]);
    }

    // Validação rápida de CRS/coords (diagnóstico de NaN/LatLng inválido)
    function assertGeoJSONLooksLikeLonLat(fc, sampleN = 3) {
      const coords = [];

      function walkGeom(g) {
        if (!g) return;
        const t = g.type;
        const c = g.coordinates;
        if (!t || !c) return;

        if (t === "Point") coords.push(c);
        else if (t === "MultiPoint" || t === "LineString") c.forEach(p => coords.push(p));
        else if (t === "MultiLineString") c.flat().forEach(p => coords.push(p));
        else if (t === "Polygon") c.flat().forEach(p => coords.push(p));
        else if (t === "MultiPolygon") c.flat(2).forEach(p => coords.push(p));
        else if (t === "GeometryCollection" && Array.isArray(g.geometries)) g.geometries.forEach(walkGeom);
      }

      for (const f of (fc.features || [])) {
        walkGeom(f.geometry);
        if (coords.length >= sampleN) break;
      }

      if (coords.length === 0) return { ok: false, reason: "GeoJSON sem coordenadas (vazio/sem geometria)." };

      const [lon, lat] = coords[0] || [];
      if (!Number.isFinite(lon) || !Number.isFinite(lat)) return { ok: false, reason: "Coordenadas inválidas (NaN/null)." };

      const inLonLatRange = (Math.abs(lon) <= 180 && Math.abs(lat) <= 90);
      if (!inLonLatRange) {
        return { ok: false, reason: `Parece CRS errado (ex.: TM06/3857). Exemplo coord: [${lon}, ${lat}]` };
      }

      return { ok: true, reason: "ok" };
    }

    // -----------------------------
    // Sanitização de GeoJSON (evita Leaflet NaN/LatLng)
    // -----------------------------
    function coordPairOk(pair) {
      if (!Array.isArray(pair) || pair.length < 2) return false;

      const lon = (typeof pair[0] === "string") ? Number(pair[0]) : pair[0];
      const lat = (typeof pair[1] === "string") ? Number(pair[1]) : pair[1];

      if (!Number.isFinite(lon) || !Number.isFinite(lat)) return false;

      // faixa “lon/lat”
      if (Math.abs(lon) > 180 || Math.abs(lat) > 90) return false;

      return true;
    }

    function geometryHasOnlyValidCoords(geom) {
      if (!geom) return false;

      const t = geom.type;
      const c = geom.coordinates;

      if (t === "Point") return coordPairOk(c);

      if (t === "MultiPoint" || t === "LineString") {
        return Array.isArray(c) && c.every(coordPairOk);
      }

      if (t === "MultiLineString" || t === "Polygon") {
        return Array.isArray(c) && c.every(line => Array.isArray(line) && line.every(coordPairOk));
      }

      if (t === "MultiPolygon") {
        return Array.isArray(c) && c.every(poly =>
          Array.isArray(poly) && poly.every(ring =>
            Array.isArray(ring) && ring.every(coordPairOk)
          )
        );
      }

      if (t === "GeometryCollection") {
        return Array.isArray(geom.geometries) && geom.geometries.every(geometryHasOnlyValidCoords);
      }

      return false;
    }

    function sanitizeFeatureCollection(fc) {
      const features = Array.isArray(fc?.features) ? fc.features : [];
      const kept = [];
      let dropped = 0;
      const droppedNames = [];

      for (const f of features) {
        if (geometryHasOnlyValidCoords(f?.geometry)) {
          kept.push(f);
        } else {
          dropped++;
          // tentar capturar um nome útil para debug
          const p = f?.properties || {};
          const n = getMunicipalityName(p) || getParishName(p) || pickProp(p, ["NAME","Name","NOME","nome"]);
          if (n) droppedNames.push(n);
        }
      }

      return {
        cleaned: { ...fc, features: kept },
        dropped,
        total: features.length,
        droppedNames
      };
    }

    // Cache de downloads
    const cache = new Map();
    async function loadJSON(url) {
      if (cache.has(url)) return cache.get(url);

      const p = fetch(url).then(async (r) => {
        if (!r.ok) throw new Error(`Falha a carregar ${url} (HTTP ${r.status})`);
        const txt = await r.text();
        const clean = (txt.charCodeAt(0) === 0xFEFF) ? txt.slice(1) : txt;
        return JSON.parse(clean);
      });

      cache.set(url, p);
      return p;
    }

    // -----------------------------
    // Screens / Loading
    // -----------------------------
    const screenMenu = document.getElementById("screenMenu");
    const screenLoading = document.getElementById("screenLoading");
    const screenGame = document.getElementById("screenGame");

    const loadingText = document.getElementById("loadingText");
    const loadingBar = document.getElementById("loadingBar");
    const loadingPct = document.getElementById("loadingPct");

    function showScreen(el) {
      for (const s of [screenMenu, screenLoading, screenGame]) s.classList.remove("active");
      el.classList.add("active");
    }
    function setLoading(step, pct) {
      loadingText.textContent = step;
      loadingBar.style.width = `${pct}%`;
      loadingPct.textContent = `${pct}%`;
    }

    // -----------------------------
    // UI Elements
    // -----------------------------
    const gameModeSel = document.getElementById("gameMode");
    const viewModeSel = document.getElementById("viewMode");
    const labelDistrict = document.getElementById("labelDistrict");
    const districtSel = document.getElementById("district");
    const labelMunicipality = document.getElementById("labelMunicipality");
    const municipalitySel = document.getElementById("municipality");

    const guessInput = document.getElementById("guess");
    const titleLine = document.getElementById("titleLine");
    const scoreLine = document.getElementById("scoreLine");
    const hintLine = document.getElementById("hintLine");
    const msgEl = document.getElementById("msg");

    const btnShowMissing = document.getElementById("btnShowMissing");
    const btnHideMissing = document.getElementById("btnHideMissing");
    const btnRevealAll = document.getElementById("btnRevealAll");
    const missingBlock = document.getElementById("missingBlock");
    const missingList = document.getElementById("missingList");
    const dataHint = document.getElementById("dataHint");

    function setMsg(text, type="neutral") {
      msgEl.className = "msg " + type;
      msgEl.textContent = text || "";
    }

    // -----------------------------
    // Map (sem tiles) + SEM ANIMAÇÕES (evita crash com bounds/coords)
    // -----------------------------
    const map = L.map("map", {
      zoomControl: true,
      attributionControl: false,
      zoomAnimation: false,
      fadeAnimation: false,
      markerZoomAnimation: false
    });
    map.setView([39.5, -8.0], 7);

    let fillLayer = null;
    let byKey = new Map();
    let keyToOfficial = new Map();
    let solved = new Set();
    let total = 0;

    function styleFill(feature) {
      const props = feature.properties || {};
      const mode = gameModeSel.value;

      const raw = (mode === "municipios") ? getMunicipalityName(props) : getParishName(props);
      const key = normalize(raw);
      const ok = solved.has(key);

      return {
        color: "#000",
        weight: 1.1,
        fillColor: ok ? "#111" : "#fff",
        fillOpacity: 1
      };
    }

    function clearLayer() {
      if (fillLayer) fillLayer.remove();
      fillLayer = null;
      byKey.clear();
      keyToOfficial.clear();
      solved.clear();
      total = 0;
      scoreLine.textContent = "0";
      setMsg("");
      missingBlock.style.display = "none";
    }

    function buildLayer(fc) {
      clearLayer();

      // Sanitizar antes de passar ao Leaflet
      const { cleaned, dropped, total: totalIn, droppedNames } = sanitizeFeatureCollection(fc);

      if (dropped > 0) {
        console.warn(`Sanitize: removidas ${dropped}/${totalIn} features por coords inválidas.`);
        if (droppedNames && droppedNames.length) {
          console.warn("Exemplos removidos:", droppedNames.slice(0, 12));
        }
      }

      if (!cleaned.features || cleaned.features.length === 0) {
        throw new Error("GeoJSON sem features válidas (tudo foi filtrado por coordenadas inválidas).");
      }

      fillLayer = L.geoJSON(cleaned, {
        style: styleFill,
        onEachFeature: (feature, lyr) => {
          const p = feature.properties || {};
          const mode = gameModeSel.value;

          const raw = (mode === "municipios") ? getMunicipalityName(p) : getParishName(p);
          const key = normalize(raw);

          if (key) {
            byKey.set(key, lyr);
            keyToOfficial.set(key, raw);
          }

          if (viewModeSel.value === "treino" && raw) {
            lyr.bindTooltip(raw, { sticky: true, opacity: 0.85 });
          }
        }
      }).addTo(map);

      total = byKey.size;

      // Só faz fitBounds se os bounds forem válidos
      try {
        // garantir que o mapa tem size correto (screens usam display:none)
        map.invalidateSize(true);

        const b = fillLayer.getBounds();
        if (b && b.isValid && b.isValid()) {
          map.fitBounds(b, { padding: [12, 12], animate: false });
        } else {
          console.warn("Bounds inválidos (geojson vazio ou geometria inválida).");
        }
      } catch (e) {
        console.warn("Falha ao calcular bounds:", e);
      }

      updateUI();
    }

    function refreshStyles() {
      if (!fillLayer) return;
      fillLayer.setStyle(styleFill);
    }

    function renderMissingList() {
      const missing = [];
      for (const [key, official] of keyToOfficial.entries()) {
        if (!solved.has(key)) missing.push(official);
      }
      missing.sort((a,b)=>a.localeCompare(b,"pt"));

      missingList.innerHTML = "";
      for (const name of missing) {
        const li = document.createElement("li");
        li.textContent = name;
        missingList.appendChild(li);
      }
    }

    function updateUI() {
      scoreLine.textContent = `${solved.size} / ${total}`;

      const regionLabel =
        (currentRegion === "pt") ? "Portugal Continental" :
        (currentRegion === "az") ? "Zonas Autónomas — Açores" :
        "Zonas Autónomas — Madeira";

      if (gameModeSel.value === "municipios") {
        if (currentRegion === "pt") {
          const dName = districtSel.options[districtSel.selectedIndex]?.textContent || "—";
          titleLine.textContent = `${regionLabel} — Distrito: ${dName}`;
        } else {
          titleLine.textContent = `${regionLabel} — Municípios`;
        }
      } else {
        const mName = municipalitySel.options[municipalitySel.selectedIndex]?.textContent || "—";
        titleLine.textContent = `${regionLabel} — Município: ${mName}`;
      }

      if (viewModeSel.value === "jogo") {
        hintLine.textContent = "Modo Jogo: escreve nomes; vai ficando a escuro.";
        btnShowMissing.style.display = "none";
        btnHideMissing.style.display = "none";
        btnRevealAll.style.display = "none";
        missingBlock.style.display = "none";
      } else {
        hintLine.textContent = "Modo Treino: podes ver faltas e revelar tudo.";
        btnShowMissing.style.display = (missingBlock.style.display === "none") ? "inline-block" : "none";
        btnHideMissing.style.display = (missingBlock.style.display === "none") ? "none" : "inline-block";
        btnRevealAll.style.display = "inline-block";
        if (missingBlock.style.display !== "none") renderMissingList();
      }

      if (currentRegion === "pt") {
        dataHint.innerHTML = `concelhos_${districtSel.value}.geojson<br>freguesias_&lt;municipio&gt;.geojson`;
      } else if (currentRegion === "az") {
        dataHint.innerHTML = `concelhos_acores.geojson<br>freguesias_&lt;municipio&gt;.geojson`;
      } else {
        dataHint.innerHTML = `concelhos_madeira.geojson<br>freguesias_&lt;municipio&gt;.geojson`;
      }
    }

    // -----------------------------
    // Estado: Região e datasets
    // -----------------------------
    let currentRegion = "pt";

    async function loadConcelhosForCurrentSelection() {
      setLoading("A carregar concelhos…", 35);

      if (currentRegion === "pt") {
        const url = FILES.concelhosPT(districtSel.value);
        const fc = await loadJSON(url);

        const check = assertGeoJSONLooksLikeLonLat(fc);
        if (!check.ok) throw new Error(`GeoJSON inválido: ${check.reason} (${url})`);

        setLoading("A desenhar…", 85);
        buildLayer(fc);
        return;
      }

      const url = (currentRegion === "az") ? FILES.concelhosAZ : FILES.concelhosMD;
      const fc = await loadJSON(url);

      const check = assertGeoJSONLooksLikeLonLat(fc);
      if (!check.ok) throw new Error(`GeoJSON inválido: ${check.reason} (${url})`);

      setLoading("A desenhar…", 85);
      buildLayer(fc);
    }

    function municipalitiesFromConcelhos(fc) {
      const set = new Set();
      for (const f of (fc.features || [])) {
        const n = getMunicipalityName(f.properties || {});
        if (n) set.add(n);
      }
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"pt"));
    }

    async function populateMunicipalitySelector() {
      let concelhosFC;

      if (currentRegion === "pt") {
        const url = FILES.concelhosPT(districtSel.value);
        concelhosFC = await loadJSON(url);
      } else {
        const url = (currentRegion === "az") ? FILES.concelhosAZ : FILES.concelhosMD;
        concelhosFC = await loadJSON(url);
      }

      const munis = municipalitiesFromConcelhos(concelhosFC);

      municipalitySel.innerHTML = "";
      for (const m of munis) municipalitySel.appendChild(new Option(m, slugify(m)));
    }

    async function loadFreguesiasForSelectedMunicipality() {
      setLoading("A carregar freguesias…", 45);

      const muniSlug = municipalitySel.value;
      const url = FILES.freguesias(currentRegion, muniSlug);

      const fc = await loadJSON(url);

      const check = assertGeoJSONLooksLikeLonLat(fc);
      if (!check.ok) throw new Error(`GeoJSON inválido: ${check.reason} (${url})`);

      setLoading("A desenhar…", 85);
      buildLayer(fc);
    }

    // -----------------------------
    // Fluxo UI por região e modo
    // -----------------------------
    function applyRegionToUI() {
      if (currentRegion === "pt") {
        labelDistrict.style.display = "";
      } else {
        labelDistrict.style.display = "none";
      }
    }

    async function applyModeToUIAndLoad() {
      const mode = gameModeSel.value;

      solved.clear();
      refreshStyles();
      missingBlock.style.display = "none";
      setMsg("");

      showScreen(screenLoading);

      try {
        if (mode === "municipios") {
          labelMunicipality.style.display = "none";
          guessInput.placeholder = "Escreve um município…";
          setLoading("A preparar…", 10);
          await loadConcelhosForCurrentSelection();
        } else {
          labelMunicipality.style.display = "";
          guessInput.placeholder = "Escreve uma freguesia…";

          setLoading("A preparar lista de municípios…", 15);
          await populateMunicipalitySelector();

          setLoading("A carregar mapa do município…", 30);
          await loadFreguesiasForSelectedMunicipality();
        }

        showScreen(screenGame);

        // CRÍTICO: Leaflet + display:none => size 0 => problemas no renderer
        setTimeout(() => {
          try { map.invalidateSize(true); } catch {}
        }, 0);

        updateUI();
        guessInput.focus();
        setLoading("Concluído", 100);
      } catch (e) {
        console.error(e);
        showScreen(screenGame);

        // também força size correto quando cai em erro e muda de screen
        setTimeout(() => {
          try { map.invalidateSize(true); } catch {}
        }, 0);

        setMsg(`Erro: ${e.message}`, "bad");
      }
    }

    // -----------------------------
    // Adivinhação (input)
    // -----------------------------
    function resolveTypedToKey(typedNorm) {
      if (byKey.has(typedNorm)) return typedNorm;

      const simplified = typedNorm
        .replace(/^vila nova de /, "")
        .replace(/^santa maria da /, "")
        .replace(/^sao /,"")
        .replace(/^são /,"")
        .trim();

      if (byKey.has(simplified)) return simplified;
      return "";
    }

    function handleGuess(rawInput) {
      const typed = normalize(rawInput);
      if (!typed) return;

      const key = resolveTypedToKey(typed);
      if (!key) {
        setMsg(`Não encontrado: "${rawInput}"`, "bad");
        return;
      }

      if (solved.has(key)) {
        setMsg(`Já estava: ${keyToOfficial.get(key) || rawInput}`, "neutral");
        return;
      }

      solved.add(key);
      refreshStyles();
      setMsg(`Certo: ${keyToOfficial.get(key) || rawInput}`, "good");
      updateUI();

      if (solved.size === total && total > 0) setMsg("Concluído. Acertaste tudo.", "good");
    }

    // -----------------------------
    // Eventos
    // -----------------------------
    document.getElementById("backToMenu").addEventListener("click", () => {
      clearLayer();
      showScreen(screenMenu);
    });

    document.getElementById("startPT").addEventListener("click", async () => {
      currentRegion = "pt";
      showScreen(screenLoading);
      setLoading("A iniciar…", 5);

      applyRegionToUI();

      districtSel.innerHTML = "";
      for (const [name, slug] of DISTRICTS_PT) districtSel.appendChild(new Option(name, slug));
      districtSel.value = DISTRICTS_PT[0][1];

      gameModeSel.value = "municipios";
      viewModeSel.value = "jogo";

      await applyModeToUIAndLoad();
    });

    document.getElementById("startAZ").addEventListener("click", async () => {
      currentRegion = "az";
      showScreen(screenLoading);
      setLoading("A iniciar…", 5);

      applyRegionToUI();
      gameModeSel.value = "municipios";
      viewModeSel.value = "jogo";

      await applyModeToUIAndLoad();
    });

    document.getElementById("startMD").addEventListener("click", async () => {
      currentRegion = "md";
      showScreen(screenLoading);
      setLoading("A iniciar…", 5);

      applyRegionToUI();
      gameModeSel.value = "municipios";
      viewModeSel.value = "jogo";

      await applyModeToUIAndLoad();
    });

    gameModeSel.addEventListener("change", async () => {
      await applyModeToUIAndLoad();
    });

    viewModeSel.addEventListener("change", async () => {
      await applyModeToUIAndLoad();
    });

    districtSel.addEventListener("change", async () => {
      if (currentRegion !== "pt") return;
      await applyModeToUIAndLoad();
    });

    municipalitySel.addEventListener("change", async () => {
      if (gameModeSel.value !== "freguesias") return;
      await applyModeToUIAndLoad();
    });

    guessInput.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const raw = guessInput.value;
      guessInput.value = "";
      handleGuess(raw);
      guessInput.focus();
    });

    document.getElementById("reset").addEventListener("click", () => {
      solved.clear();
      refreshStyles();
      missingBlock.style.display = "none";
      setMsg("");
      updateUI();
      guessInput.focus();
    });

    btnShowMissing.addEventListener("click", () => {
      missingBlock.style.display = "block";
      renderMissingList();
      updateUI();
    });

    btnHideMissing.addEventListener("click", () => {
      missingBlock.style.display = "none";
      updateUI();
    });

    btnRevealAll.addEventListener("click", () => {
      if (viewModeSel.value !== "treino") return;
      for (const key of byKey.keys()) solved.add(key);
      refreshStyles();
      setMsg("Revelado (modo treino).", "neutral");
      updateUI();
      guessInput.focus();
    });
  </script>
</body>
</html>







